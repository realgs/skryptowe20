<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script src="dist/Chart.js"></script>

	</head>
	<body>
		<div class="menu">
			<a class="menu-link" href="index.html"><div class="menu-item"><span>Home</span><img src="images/menu/home_disable.png"></div></a>
			<a class="menu-link" href="sales.html"><div class="menu-item">Sales data<img src="images/menu/sales_disable.png"></div></a>
			<a class="menu-link" href="rates.html"><div class="menu-item active">Exchange rates<img src="images/menu/currency_enable.png"></div></a>
		</div>
		<div class="content">
			<h1>Sales data</h1>
			<div class="box">
				<a class="section-title">Generating USD -> PLN rates data</a>
				<a class="input-signature">Date from</a>
				<input type="date" id="date_start" name="date_from" min="2011-10-01" max="2014-05-28">
				<a class="input-signature">Date to</a>
				<input type="date" id="date_stop" name="date_to" min="2011-10-01" max="2014-05-28">
				<input type="submit" id="sub" name="submit_button" class="date-button" value="Generate">
				<div id="error_message"></div>
			</div>
		</div>
		<div class="content" id="data">
		</div>
		<script>
		document.getElementById("sub").onclick = function() {generateData()};
		 
		async function getapi(url) { 
			fetch(url)
			  .then(response => response.json())
			  .then(data => run(data));
		}
		
		function run(data) {
			show(data);
			createChart(data);
		}

		function generateData() {
			var date_from = document.getElementById("date_start").value;
			var date_to = document.getElementById("date_stop").value;
			var data_is_correct = true;
			document.getElementById("error_message").innerHTML = ""
			if (date_from == "") {
				data_is_correct = false;
				showErrorMessage('Enter a valid start date.<br>', "error_message")
			}
			if (date_to == "") {
				data_is_correct = false;
				showErrorMessage('Enter a valid stop date.<br>', "error_message")
			}
			if (date_to < date_from && date_from != "" && date_to != "") {
				data_is_correct = false;
				showErrorMessage('"date from" must be earlier than "date to"<br>', "error_message")
			}
			if (data_is_correct) {
				var api_url = "http://127.0.0.1:5000/rates/pln/" + date_from + "/" + date_to; 
				var apiData = getapi(api_url); 
				
				left_div = document.createElement("div");
				left_div.setAttribute("class", "box-left");
				left_div.setAttribute("id", "box-left");
				currency_data_table = document.createElement("table");
				currency_data_table.setAttribute("id", "rates_table");
				document.getElementById("data").innerHTML = "";
				document.getElementById("data").appendChild(left_div);
				document.getElementById("box-left").appendChild(currency_data_table);
				document.getElementById("rates_table").innerHTML = apiData["result"];	
				
				right_div = document.createElement("div");
				right_div.setAttribute("class", "box-right");
				right_div.setAttribute("id", "box-right");
				right_div.innerHTML = '<canvas id="myChart" width="400" height="400"></canvas>';
				document.getElementById("data").appendChild(right_div);
				
				document.getElementById("error_message").innerHTML = ""
			}
		}
		
		function showErrorMessage(content_to_display, who_display) {
			new_element = document.createElement("a");
			new_element.style.color = "#FC6749";
			new_element.innerHTML = content_to_display;
			document.getElementById(who_display).appendChild(new_element);
			document.getElementById("data").innerHTML = "";
		}

		function show(data) { 
			let tab =  "<thead><tr><th>Date</th><th>Middle rate</th><th>Is interpolated</th></tr></thead>";
			var mid_rates_tab_two = [];
			for (let r of data["result"]["rates"]) {
				tab += '<tr><td>' + r["date"] + '</td><td>' + r["mid_rate"] + '</td><td>' + r["is_interpolated"] + '</td></tr>'; 
				mid_rates_tab_two.push(r["mid_rate"]);
			}
			document.getElementById("rates_table").innerHTML = tab; 
		}
		
		function createChart(data) {
			var dataFromChart = saveToChart(data);
			var dateDataFromChart = getApiDate(data);
			var ctx = document.getElementById('myChart').getContext('2d');
			var myChart = new Chart(ctx, {
				type: 'bar',
				data: {
					labels: dataFromChart[0],
					datasets: [{
						label: 'Exchange rate',
						data: dataFromChart[1],
						backgroundColor: function(context) {
							var index = context.dataIndex;
							var value = dataFromChart[2][index]
							return value == true ? '#FC6749' :
								'#0c9';
						}
					}]
				},
				options: {
					scales: {
						yAxes: [{
							ticks: {
								beginAtZero: false
							}
						}]
					}
				}
			})
		}
					
		
		function saveToChart(data) {
			var date = [];
			for (let r of data["result"]["rates"]) {
				date.push(r["date"]);
			}
			var mid_rates = [];
			for (let r of data["result"]["rates"]) {
				mid_rates.push(r["mid_rate"]);
			}
			var is_interpolated = [];
			for (let r of data["result"]["rates"]) {
				is_interpolated.push(r["is_interpolated"]);
			}
			
			var table = [date, mid_rates, is_interpolated]
			return table;
		}
		
		function getApiDate(data) {
			var dates = [];
			for (let r of data["result"]["rates"]) {
				dates.push(r["date"]);
			}
			return dates;
		}
		</script>
	</body>
</html>