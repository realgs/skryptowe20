<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sales data</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="dist/Chart.js"></script>
</head>
<body>
    <div class="menu_bg">
        <div class="menu">
            <a class="menu-link" href="index.html">
                <div class="menu-item">
                    <span>Home</span>
                    <img src="images/home2.png" alt="Homepage image">
                </div>
            </a>
            <a class="menu-link" href="sales.html">
                <div class="menu-item active">
                    <span>Sales data</span>
                    <img src="images/sales.png" alt="Sales page image">
                </div>
            </a>
            <a class="menu-link" href="rates.html">
                <div class="menu-item">
                    <span>Exchange rates</span>
                    <img src="images/exchange-rate2.png" alt="Rates page image">
                </div>
            </a>
        </div>
    </div>
    <div class="content">
        <h1>Sales data</h1>
        <div class="box">
            <h3 class="section-title">Sales value in USD and the selected currency</h3>
            <a style="padding-bottom:10px;display:block;">If you would like to know the currency rate from one day, just enter "date from"</a>
            <p class="date_choose">Date from</p>
            <p class="date_choose">Date to</p><br>
            <input class="date_choose" type="date" id="start_date" name="date" min="2011-10-01" max="2014-05-28">
            <input class="date_choose" type="date" id="end_date" name="date" min="2011-10-01" max="2014-05-28"><br>
            <div class="select-div">
                <a class="input-signature">Currency</a>
                <select name="currency" id="idCurrency">
                    <option value="AUD">AUD</option>
                    <option value="BYN">BYN</option>
                    <option value="BGN">BGN</option>
                    <option value="HRK">HRK</option>
                    <option value="DKK">DKK</option>
                    <option value="JPY">JPY</option>
                    <option value="CAD">CAD</option>
                    <option value="NOK">NOK</option>
                    <option value="CZK">CZK</option>
                    <option value="RUB">RUB</option>
                    <option value="RON">RON</option>
                    <option value="PLN">PLN</option>
                    <option value="CHF">CHF</option>
                    <option value="SEK">SEK</option>
                    <option value="TRY">TRY</option>
                    <option value="EUR">EUR</option>
                    <option value="UAH">UAH</option>
                    <option value="HUF">HUF</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>
            <input type="submit" id="sub" name="submit_button" class="generate-button" value="Generate">
            <div id="error_message"></div>
        </div>
    </div>
    <div class="content" id="data">
    </div>



    <script>
        document.getElementById("sub").onclick = function() {
            generate()
        };

        async function getapidata(url) {
            fetch(url)
                .then(response => response.json())
                .then(data => run(data));
        }

        function run(data) {
            show(data);
            createChart(data);
        }

        function generate() {
            const start_date = document.getElementById("start_date").value;
            let end_date = document.getElementById("end_date").value;
            const currency = document.getElementById("idCurrency").value;
            let data_correctness = true;
            document.getElementById("error_message").innerHTML = ""
            if (start_date === "") {
                data_correctness = false;
                showErrorMessage('Enter a valid start date.<br>', "error_message")
            }
            if (end_date === "") {
                end_date = start_date
            }
            if (end_date < start_date && start_date !== "" && end_date !== "") {
                data_correctness = false;
                showErrorMessage('"date from" must be earlier than "date to"<br>', "error_message")
            }
            let first_box;
            let currency_data_table;
            let second_box;
            if (data_correctness) {
                const api_url = "http://127.0.0.1:5000/sales/" + currency + "/" + start_date + "/" + end_date;
                const apiData = getapidata(api_url);

                first_box = document.createElement("div");
                first_box.setAttribute("class", "box");
                first_box.setAttribute("id", "fst-box");
                currency_data_table = document.createElement("table");
                currency_data_table.setAttribute("id", "rates_table");
                document.getElementById("data").innerHTML = "";
                document.getElementById("data").appendChild(first_box);
                document.getElementById("fst-box").appendChild(currency_data_table);
                document.getElementById("rates_table").innerHTML = apiData["result"];

                second_box = document.createElement("div");
                second_box.setAttribute("class", "box");
                second_box.setAttribute("id", "scd-box");
                second_box.innerHTML = '<canvas id="myChart" width="400" height="200"></canvas>';
                document.getElementById("data").appendChild(second_box);

                document.getElementById("error_message").innerHTML = ""
            }
        }

        function showErrorMessage(content_to_display, who_display) {
            const new_element = document.createElement("a");
            new_element.style.color = "#fc6749";
            new_element.innerHTML = content_to_display;
            document.getElementById(who_display).appendChild(new_element);
            document.getElementById("data").innerHTML = "";
        }

        function show(data) {
            let tab =  "<thead><tr><th>Date</th><th>USD</th></th><th>" + document.getElementById("idCurrency").value + "</th></tr></thead>";
            const dataFromChart = saveToChart(data);
            let i;
            for (i = 0; i < dataFromChart[0].length; i++) {
                tab += '<tr><td>' + dataFromChart[2][i] + '</td><td>' + dataFromChart[0][i] + '</td><td>' + dataFromChart[1][i] + '</td></tr>';
            }
            document.getElementById("rates_table").innerHTML = tab;
        }

        function createChart(data) {
            const dataFromChart = saveToChart(data);
            const ctx = document.getElementById('myChart').getContext('2d');
            const other_currency = document.getElementById("idCurrency").value;
            const myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dataFromChart[2],
                    datasets: [{
                        label: 'USD',
                        data: dataFromChart[0],
                        backgroundColor: 'rgba(255, 99, 132, 0.8)'
                    }, {
                        label: other_currency,

                        data: dataFromChart[1],
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
        }


        function saveToChart(data) {
            const usdValue = [];
            for (let r of data["result"]["sales"]) {
                usdValue.push(r[0]["value"]);
            }
            const otherCurrencyValue = [];
            for (let r of data["result"]["sales"]) {
                otherCurrencyValue.push(r[1]["value"]);
            }

            const dateTable = [];
            for (let r of data["result"]["sales"]) {
                dateTable.push(r[0]["date"]);
            }

            return [usdValue, otherCurrencyValue, dateTable];
        }
    </script>
</body>
</html>